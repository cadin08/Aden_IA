<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aden â€” Asistente IA (Demo local)</title>
<style>
  :root{
    --bg-0:#071126; --bg-1:#081426; --panel:#0b1a2a;
    --muted:#9fb0c8; --accent-1:#57e4b8; --accent-2:#6fb7ff;
    --radius:12px; --shadow: 0 12px 32px rgba(2,8,23,0.6);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-0),var(--bg-1));color:#eaf6ff}
  .wrap{max-width:1180px;margin:26px auto;padding:18px;display:grid;grid-template-columns:320px 1fr;gap:18px}
  .sidebar{padding:14px;border-radius:var(--radius);box-shadow:var(--shadow);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:flex;flex-direction:column}
  .logo{width:50px;height:50px;border-radius:10px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#042b2a}
  .brand{display:flex;gap:12px;align-items:center}
  .controls{display:flex;gap:8px;margin:10px 0}
  .btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px;color:var(--muted);cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));border:none;color:#052a26}
  .search{display:flex;gap:8px;align-items:center}
  .search input{flex:1;padding:10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)}
  .chats{margin-top:12px;flex:1;overflow:auto;display:flex;flex-direction:column;gap:10px;padding-right:6px}
  .chat-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);cursor:pointer}
  .panel{padding:16px;border-radius:var(--radius);box-shadow:var(--shadow);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));display:flex;flex-direction:column;min-height:64vh}
  .panel-header{display:flex;align-items:center;justify-content:space-between}
  .messages{flex:1;margin-top:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);overflow:auto;border:1px dashed rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:12px}
  .bubble{max-width:78%;padding:12px 14px;border-radius:14px;line-height:1.45}
  .bubble.user{align-self:flex-end;background:linear-gradient(180deg,#071425,#061422);border:1px solid rgba(255,255,255,0.02)}
  .bubble.assistant{align-self:flex-start;background:linear-gradient(180deg,#022b2a,#062c3c);border:1px solid rgba(255,255,255,0.02)}
  .compose{display:flex;gap:12px;margin-top:12px;align-items:flex-end}
  textarea{flex:1;padding:14px;border-radius:12px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted);min-height:72px;resize:none}
  .chip{padding:8px 10px;border-radius:999px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
  .muted{color:var(--muted)}
  @media (max-width:980px){.wrap{grid-template-columns:1fr;padding:12px}.sidebar{order:2}}
</style>
</head>
<body>
<div class="wrap" role="application" aria-label="Aden â€” Asistente local">
  <aside class="sidebar" aria-label="Barra lateral">
    <div class="brand">
      <div class="logo">Ad</div>
      <div>
        <h1 id="brandName">Aden â€” Asistente</h1>
        <p class="muted">Demo local â€” todo en tu navegador</p>
      </div>
    </div>

    <div class="controls">
      <button id="newChatBtn" class="btn primary">+ Nuevo</button>
      <button id="exportAllBtn" class="btn">Exportar</button>
      <button id="resetLocal" class="btn">Reset</button>
    </div>

    <div class="search">
      <input id="searchChats" placeholder="Buscar..." />
    </div>

    <div class="chats" id="chatsList" tabindex="0" aria-live="polite"></div>

    <div style="margin-top:12px;font-size:13px;color:var(--muted)">
      LÃ­mite respuestas/chat: <span id="limitDisplay">8</span>
      <div style="margin-top:8px"><button id="decLimit" class="btn">-</button><button id="incLimit" class="btn">+</button></div>
    </div>
  </aside>

  <main class="panel" aria-live="polite">
    <div class="panel-header">
      <div>
        <h2 id="panelTitle">Selecciona o crea un chat</h2>
        <div id="responsesLeft" class="muted"></div>
      </div>
      <div>
        <button id="renameChatBtn" class="btn">Renombrar</button>
        <button id="clearChatBtn" class="btn">Vaciar</button>
        <button id="deleteChatBtn" class="btn">Eliminar</button>
      </div>
    </div>

    <div class="messages" id="messagesArea">
      <div class="muted">Crea un chat y prueba preguntas (ej.: "Â¿QuÃ© hora es?", "Â¿QuiÃ©n fue Albert Einstein?", "EscrÃ­beme un correo formal").</div>
    </div>

    <div style="display:flex;flex-direction:column;gap:8px;margin-top:12px">
      <div style="display:flex;gap:8px;flex-wrap:wrap" id="suggestions"></div>

      <div class="compose">
        <textarea id="inputTxt" placeholder="Escribe tu mensaje... (Enter = enviar, Shift+Enter = nueva lÃ­nea)"></textarea>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button id="sendBtn" class="btn primary">Enviar</button>
          <div style="display:flex;gap:6px">
            <button id="undoBtn" class="btn">â†¶</button>
            <button id="redoBtn" class="btn">â†·</button>
            <button id="ttsToggle" class="btn">ðŸ”Š</button>
          </div>
          <div class="muted" id="charCount">0 caracteres</div>
        </div>
      </div>
    </div>
  </main>
</div>

<script>
/* Aden â€” Asistente local (todo en un archivo)
   - DiseÃ±ado para responder a la extensa lista de preguntas del usuario
   - Respuestas especÃ­ficas, variantes y plantillas (para preguntas en tiempo real explica cÃ³mo obtener datos)
   - TTS opcional
*/

/* ---------- Config y estado ---------- */
const STORAGE_KEY = 'aden_v1';
const DEFAULT_LIMIT = 8;
let chats = [];
let activeChatId = null;
let assistantLimit = DEFAULT_LIMIT;
let undoStack = [], redoStack = [];
let ttsEnabled = false;

/* ---------- Responsores: mapeo exhaustivo para la lista del usuario ----------
   Cada objeto contiene:
     id, keywords (tokens), phrases (frases clave), replies (strings o funciones)
   Si la pregunta requiere datos en tiempo real (ej. "pelÃ­culas de hoy"), la respuesta explica
   cÃ³mo obtenerlos y ofrece una plantilla fetch para el usuario.
*/
const RESPONDERS = [
  /* --- Preguntas generales (hora, fecha, clima sin API, capitales, definiciones, hechos) --- */
  { id:'time', keywords:['hora','quÃ© hora','que hora es','hora es'], phrases:[], replies: [
    () => `La hora local en tu navegador es ${new Date().toLocaleTimeString()}.`,
    () => `Ahora mismo son las ${new Date().toLocaleTimeString()}.`
  ], priority:20 },

  { id:'today_date', keywords:['dÃ­a','hoy','fecha','quÃ© dÃ­a'], phrases:['quÃ© dÃ­a es hoy','que dia es hoy'], replies:[
    () => `Hoy es ${new Date().toLocaleDateString()} (${new Date().toLocaleString([], {weekday:'long', year:'numeric', month:'long', day:'numeric'})}).`
  ], priority:20 },

  { id:'weather_now', keywords:['tiempo ahora','quÃ© tiempo','quÃ© tiempo hace','clima ahora'], phrases:['quÃ© tiempo hace ahora'], replies:[
    'No puedo obtener el clima en tiempo real en esta demo local. Si quieres, te doy un ejemplo `fetch` para OpenWeatherMap para obtener el clima de una ciudad.',
    (t) => `Para obtener el clima ahora mismo, usa esta plantilla Fetch (reemplaza YOUR_API_KEY y la ciudad):\n\n` +
           "fetch(`https://api.openweathermap.org/data/2.5/weather?q=Ciudad&appid=YOUR_API_KEY&units=metric`)\n" +
           ".then(r=>r.json()).then(j=>console.log(j))\n"
  ], priority:18 },

  { id:'rain_tomorrow', keywords:['llover maÃ±ana','va a llover maÃ±ana','lluvia maÃ±ana'], phrases:[], replies:[
    'No puedo predecir el tiempo sin acceso a una API meteorolÃ³gica. Puedo mostrarte cÃ³mo consultar previsiones (OpenWeatherMap / WeatherAPI) si quieres.',
    'Plantilla: solicita la previsiÃ³n para maÃ±ana con la API de tu elecciÃ³n y mira la probabilidad de precipitaciÃ³n (pop).'
  ], priority:16 },

  { id:'capital_japan', keywords:['capital japÃ³n','capital de japÃ³n','capital japan'], phrases:['cuÃ¡l es la capital de japÃ³n','cual es la capital de japon'], replies:[
    'La capital de JapÃ³n es Tokio (Tokyo).', 'Tokio es la capital y la ciudad mÃ¡s poblada de JapÃ³n.'
  ], priority:20 },

  { id:'resilience_def', keywords:['resiliencia','quÃ© significa resiliencia','significa resiliencia'], phrases:[], replies:[
    'Resiliencia: la capacidad de una persona o sistema para recuperarse y adaptarse ante circunstancias adversas o cambios.',
    'En psicologÃ­a, la resiliencia es la habilidad para afrontar dificultades, aprender de ellas y volver a un estado funcional.'
  ], priority:16 },

  { id:'who_invented_electricity', keywords:['inventÃ³ la electricidad','quien invento la electricidad','quiÃ©n inventÃ³ la electricidad'], phrases:[], replies:[
    'La "electricidad" no fue inventada por una sola persona; fue un fenÃ³meno natural investigado por muchos. Figuras clave: Benjamin Franklin (experimentos con rayos), Michael Faraday (inducciÃ³n electromagnÃ©tica), Alessandro Volta (pila elÃ©ctrica), James Clerk Maxwell (teorÃ­a electromagnÃ©tica).'
  ], priority:15 },

  { id:'population_spain', keywords:['habitantes espaÃ±a','cuÃ¡ntos habitantes tiene espaÃ±a','poblaciÃ³n espaÃ±a'], phrases:[], replies:[
    'No tengo acceso a la Ãºltima cifra en tiempo real; la poblaciÃ³n cambia. Puedes consultar el INE (Instituto Nacional de EstadÃ­stica) o Wikipedia para la cifra actualizada.',
    'A modo orientativo, EspaÃ±a tiene alrededor de 47-48 millones de habitantes (verifica la cifra exacta en fuentes oficiales).'
  ], priority:14 },

  { id:'math_simple', keywords:['25 por 47','25x47','25 * 47','cuÃ¡nto es 25 por 47'], phrases:[], replies:[
    () => `25 Ã— 47 = ${25*47}.`
  ], priority:20 },

  { id:'distance_madrid_paris', keywords:['kilÃ³metros madrid paris','distancia madrid parÃ­s','distancia madrid paris'], phrases:[], replies:[
    'La distancia en lÃ­nea recta entre Madrid y ParÃ­s es aproximadamente 1,050 km; la distancia por carretera/tren es mayor (alrededor de 1,270 km). Verifica rutas exactas en un buscador de mapas.'
  ], priority:14 },

  /* --- Cultura general y curiosidades --- */
  { id:'einstein', keywords:['albert einstein','quiÃ©n fue albert einstein','quien fue einstein'], phrases:[], replies:[
    'Albert Einstein fue un fÃ­sico teÃ³rico famoso por la teorÃ­a de la relatividad (E = mcÂ²). RecibiÃ³ el Nobel de FÃ­sica en 1921 por su trabajo sobre el efecto fotoelÃ©ctrico.',
    'Einstein (1879â€“1955) transformÃ³ la fÃ­sica moderna con la relatividad especial y general, y contribuyÃ³ a la fÃ­sica cuÃ¡ntica.'
  ], priority:18 },

  { id:'black_hole', keywords:['agujero negro','quÃ© es un agujero negro'], phrases:[], replies:[
    'Un agujero negro es una regiÃ³n del espacio con gravedad tan intensa que nada puede escapar de ella, ni siquiera la luz. Se forma cuando una masa suficientemente densa colapsa gravitacionalmente.',
    'Se describen por su horizonte de sucesos; su existencia fue predicha por la teorÃ­a de la relatividad general de Einstein.'
  ], priority:16 },

  { id:'largest_country', keywords:['paÃ­s mÃ¡s grande','paÃ­s mÃ¡s grande del mundo','mayor paÃ­s'], phrases:[], replies:[
    'Rusia es el paÃ­s mÃ¡s grande del mundo por superficie.',
    'Rusia ocupa la mayor extensiÃ³n territorial del planeta.'
  ], priority:16 },

  { id:'fastest_animal', keywords:['animal mÃ¡s rÃ¡pido','animal mas rapido','quÃ© animal es el mÃ¡s rÃ¡pido'], phrases:[], replies:[
    'En tierra, el guepardo (cheetah) es el mÃ¡s rÃ¡pido, alcanzando hasta ~100â€“120 km/h en cortas distancias. En el aire, el halcÃ³n peregrino en picado supera los 300 km/h.'
  ], priority:16 },

  { id:'switzerland_languages', keywords:['idiomas suiza','idiomas que se hablan en suiza'], phrases:[], replies:[
    'En Suiza se hablan cuatro idiomas oficiales: alemÃ¡n, francÃ©s, italiano y romanche. AdemÃ¡s hay dialectos y otras lenguas.'
  ], priority:16 },

  { id:'closest_planet', keywords:['planeta mÃ¡s cerca del sol','quÃ© planeta estÃ¡ mÃ¡s cerca del sol'], phrases:[], replies:[
    'Mercurio es el planeta mÃ¡s cercano al Sol.',
    'Mercurio orbita mÃ¡s cerca del Sol que cualquier otro planeta del sistema solar.'
  ], priority:16 },

  { id:'why_sky_blue', keywords:['por quÃ© el cielo es azul','por que el cielo es azul','por que el cielo es azul'], phrases:[], replies:[
    'El cielo es azul debido a la dispersiÃ³n Rayleigh: la atmÃ³sfera dispersa la luz del Sol, y las longitudes de onda cortas (azules) se dispersan mÃ¡s, haciendo que veamos el cielo azul.'
  ], priority:15 },

  { id:'highest_mountain', keywords:['montaÃ±a mÃ¡s alta','montaÃ±a mÃ¡s alta del mundo'], phrases:[], replies:[
    'La montaÃ±a mÃ¡s alta del mundo es el monte Everest (aprox. 8,848 m sobre el nivel del mar).'
  ], priority:16 },

  { id:'what_is_ai', keywords:['quÃ© es la inteligencia artificial','que es la inteligencia artificial','inteligencia artificial'], phrases:[], replies:[
    'La inteligencia artificial (IA) es el campo que crea sistemas y algoritmos capaces de realizar tareas que, en humanos, requieren inteligencia: aprendizaje, razonamiento y percepciÃ³n.',
    'Incluye tÃ©cnicas como aprendizaje automÃ¡tico, redes neuronales, visiÃ³n por computadora y procesamiento de lenguaje natural.'
  ], priority:16 },

  { id:'light_travel_time', keywords:['tiempo luz sol tierra','cuÃ¡nto tarda la luz del sol a la tierra','cuanto tarda la luz del sol a la tierra'], phrases:[], replies:[
    'La luz del Sol tarda aproximadamente 8 minutos y 20 segundos en llegar a la Tierra (~499 segundos).'
  ], priority:16 },

  /* --- Entretenimiento y ocio (notas: para "ahora" se sugiere cÃ³mo consultar la web) --- */
  { id:'trending_movies', keywords:['pelÃ­culas de moda','peliculas de moda ahora','peliculas de hoy','quÃ© pelÃ­culas estÃ¡n de moda'], phrases:[], replies:[
    'No puedo consultar las listas en tiempo real en esta demo local. Para ver pelÃ­culas de moda, consulta sitios como IMDb (Top Box Office), Rotten Tomatoes o Netflix/Filmaffinity. Â¿Quieres un ejemplo de cÃ³mo obtener datos con una API?'
  ], priority:12 },

  { id:'recommend_series', keywords:['serie parecida a breaking bad','si me gusta breaking bad que ver'], phrases:[], replies:[
    'Si te gustÃ³ Breaking Bad, prueba "Better Call Saul" (mismo universo), "Ozark" (drama y crimen), o "Narcos" (crimen realista).'
  ], priority:15 },

  { id:'marvel_release', keywords:['prÃ³xima pelÃ­cula de marvel','cuando se estrena marvel','estreno marvel'], phrases:[], replies:[
    'No tengo acceso a calendarios de estrenos en esta demo. Consulta fuentes oficiales (Marvel Studios) o sitios de cine como IMDb para fechas de estreno actualizadas.'
  ], priority:12 },

  { id:'steam_sales', keywords:['oferta steam','juegos en oferta steam','quÃ© juegos estÃ¡n en oferta en steam'], phrases:[], replies:[
    'No puedo listar ofertas en tiempo real sin acceso a la API de Steam. Puedes visitar la pÃ¡gina de ofertas de Steam o usar la Web API de Steam para chequear precios automÃ¡ticamente.'
  ], priority:12 },

  { id:'trailer_song', keywords:['quÃ© canciÃ³n suena en el trÃ¡iler','canciÃ³n del trÃ¡iler'], phrases:[], replies:[
    'Identificar una canciÃ³n en un trÃ¡iler requiere escuchar el audio; no puedo analizar audio en esta demo. Puedes usar apps como Shazam o buscar en la descripciÃ³n/foros del trÃ¡iler.'
  ], priority:12 },

  { id:'despacito_singer', keywords:['quiÃ©n canta despacito','quien canta despacito'], phrases:[], replies:[
    'â€œDespacitoâ€ es cantada por Luis Fonsi y Daddy Yankee (con participaciÃ³n en la versiÃ³n remix de Justin Bieber).'
  ], priority:18 },

  { id:'reggaeton_genre', keywords:['quÃ© gÃ©nero es el reggaetÃ³n','gÃ©nero reggaetÃ³n'], phrases:[], replies:[
    'El reggaetÃ³n es un gÃ©nero musical urbano que mezcla reggae/dancehall con influencias latinas, hip-hop y electrÃ³nica; originado en PanamÃ¡ y popularizado en Puerto Rico.'
  ], priority:16 },

  { id:'minecraft_like', keywords:['juegos parecidos a minecraft','similar a minecraft'], phrases:[], replies:[
    'Juegos similares a Minecraft: "Terraria" (2D sandbox), "Roblox" (creaciÃ³n y multijugador), "Valheim" (supervivencia y construcciÃ³n), "Eco", "Brickadia".'
  ], priority:14 },

  { id:'best_selling_game', keywords:['videojuego mÃ¡s vendido','juego mÃ¡s vendido de la historia'], phrases:[], replies:[
    'El videojuego mÃ¡s vendido suele considerarse "Minecraft" (mÃ¡s de 200 millones de copias vendidas). Las cifras pueden cambiar; consulta fuentes oficiales.'
  ], priority:14 },

  { id:'where_watch_onepiece', keywords:['dÃ³nde ver one piece','donde ver one piece'], phrases:[], replies:[
    'One Piece estÃ¡ disponible en plataformas de streaming segÃºn tu paÃ­s (ej. Crunchyroll, Netflix en ciertas regiones). Revisa la disponibilidad local en el servicio de streaming de tu zona.'
  ], priority:12 },

  /* --- TecnologÃ­a y software (prÃ¡ctico: pasos y comandos) --- */
  { id:'free_space_pc', keywords:['liberar espacio pc','liberar espacio en mi pc','cÃ³mo liberar espacio en mi pc'], phrases:[], replies:[
    'Pasos rÃ¡pidos: 1) Desinstala programas no usados 2) Borra archivos temporales (Disk Cleanup en Windows) 3) Mueve multimedia a disco externo o nube 4) Usa herramientas como WinDirStat para encontrar grandes archivos.'
  ], priority:18 },

  { id:'best_free_antivirus', keywords:['mejor antivirus gratuito','antivirus gratuito'], phrases:[], replies:[
    'Algunas opciones reconocidas: Avast Free, AVG Free, Microsoft Defender (integrado en Windows). El mejor depende de tus necesidades; Microsoft Defender suele ser suficiente y bien integrado.'
  ], priority:14 },

  { id:'change_steam_name', keywords:['cambiar nombre steam','cÃ³mo cambiar nombre en steam'], phrases:[], replies:[
    'En Steam: abre tu perfil â†’ Editar perfil â†’ Cambia "Nombre para mostrar". El nombre de cuenta (login) no es modificable fÃ¡cilmente; el "display name" sÃ­.'
  ], priority:16 },

  { id:'which_windows', keywords:['quÃ© versiÃ³n de windows tengo','quÃ© windows tengo'], phrases:[], replies:[
    'En Windows ve a ConfiguraciÃ³n â†’ Sistema â†’ Acerca de (o ejecuta `winver`). Esto muestra la ediciÃ³n y la versiÃ³n del sistema operativo.'
  ], priority:16 },

  { id:'onedrive_backup', keywords:['copia de seguridad onedrive','hacer copia en onedrive','backup onedrive'], phrases:[], replies:[
    'Para hacer copia en OneDrive: instala OneDrive, inicia sesiÃ³n, mueve o sincroniza la carpeta que quieras; en Windows puedes activar "Carpeta de documentos/escritorio" para sincronizar automÃ¡ticamente.'
  ], priority:15 },

  { id:'what_is_ssd', keywords:['quÃ© es una ssd','que es una ssd'], phrases:[], replies:[
    'SSD (Unidad de estado sÃ³lido) es un tipo de almacenamiento mucho mÃ¡s rÃ¡pido que HDD, sin partes mÃ³viles, usando memoria flash. Mejora tiempos de arranque y carga de programas.'
  ], priority:16 },

  { id:'light_linux', keywords:['linux mas ligero','quÃ© linux es mÃ¡s ligero','linux ligero'], phrases:[], replies:[
    'Distros ligeras: Lubuntu, Xubuntu, Linux Lite, Puppy Linux o antiX. La elecciÃ³n depende de tu hardware y preferencias de escritorio.'
  ], priority:14 },

  { id:'install_game_other_drive', keywords:['instalar juego en otra unidad','instalar juego en otra unidad steam'], phrases:[], replies:[
    'En Steam: ConfiguraciÃ³n â†’ Descargas â†’ Carpetas de la biblioteca Steam â†’ AÃ±adir carpeta en la unidad deseada. Luego instalar el juego en esa biblioteca.'
  ], priority:16 },

  { id:'pc_slow', keywords:['ordenador va lento','pc va lento','por quÃ© mi ordenador va lento'], phrases:[], replies:[
    'Posibles causas: disco lleno, demasiados procesos en segundo plano, malware, falta de RAM o temperatura alta (throttling). Ejecuta un escaneo antivirus, revisa uso de disco y procesos (Task Manager).'
  ], priority:16 },

  { id:'upload_to_cloud', keywords:['pasar archivos a la nube','subir archivos a la nube'], phrases:[], replies:[
    'Opciones: OneDrive, Google Drive, Dropbox. Puedes usar la app del servicio para sincronizar carpetas o usar la web para subir archivos manualmente.'
  ], priority:14 },

  /* --- Tareas prÃ¡cticas: plantillas y ejemplos --- */
  { id:'write_email_formal', keywords:['escrÃ­beme un correo formal','escribir correo formal'], phrases:[], replies:[
    (t) => `Claro. Dame 2 datos: 1) destinatario/rol y 2) tema breve. Mientras tanto, un ejemplo genÃ©rico:\n\nEstimado/a [Nombre],\n\nMe dirijo a usted para... (contenido)\n\nAtentamente,\n[Tu nombre]`
  ], priority:18 },

  { id:'help_cv', keywords:['ayudame a hacer un currÃ­culum','hacer currÃ­culum','curriculum'], phrases:[], replies:[
    'Puedo ayudarte a redactar tu CV. Dime: experiencia, formaciÃ³n, habilidades y puesto objetivo. Te doy formato (perfil, experiencia, educaciÃ³n, habilidades).'
  ], priority:18 },

  { id:'cover_letter', keywords:['carta de presentaciÃ³n','redacta carta de presentaciÃ³n'], phrases:[], replies:[
    (t) => `Dime el puesto y empresa, y te redacto una carta. Ejemplo genÃ©rico:\n\nEstimado/a [Nombre],\nMe llamo [Tu nombre] y me postulo para [puesto] en [empresa]...`
  ], priority:17 },

  { id:'translate_en', keywords:['tradÃºceme al inglÃ©s','traducir al ingles','translate to english'], phrases:[], replies:[
    (t) => `Pega el texto y lo traduzco al inglÃ©s. (Ej: "Hola, Â¿cÃ³mo estÃ¡s?" â†’ "Hello, how are you?")`
  ], priority:16 },

  { id:'spellcheck', keywords:['corrige ortografia','corregir ortografÃ­a','corrige la ortografia'], phrases:[], replies:[
    'Pega el texto y lo corrijo (ortografÃ­a y estilo), indicando cambios y explicaciones si quieres.'
  ], priority:16 },

  { id:'summarize_doc', keywords:['resumen documento','hazme un resumen','resume este documento'], phrases:[], replies:[
    'Pega el texto o sube un fichero; te devuelvo un resumen breve, puntos clave o un Ã­ndice de secciones.'
  ], priority:16 },

  { id:'convert_pdf', keywords:['convertir pdf','convierte a pdf','convertir a formato pdf'], phrases:[], replies:[
    'En esta demo no puedo crear archivos en el sistema por seguridad del navegador; puedo generar un blob descargable con JavaScript para convertir texto a PDF usando una librerÃ­a (ej. jsPDF). Â¿Quieres un ejemplo?'
  ], priority:14 },

  { id:'todo_list', keywords:['crear lista de tareas','lista de tareas','hacer lista de tareas'], phrases:[], replies:[
    'Dime las tareas y te devuelvo una lista ordenada con prioridades y estimaciÃ³n de tiempo.'
  ], priority:14 },

  { id:'weekly_schedule', keywords:['horario semanal','hacer un horario semanal','horario'], phrases:[], replies:[
    'Dime tus franjas disponibles y tareas, y te creo un horario semanal con bloques y recordatorios sugeridos.'
  ], priority:14 },

  { id:'reminder', keywords:['recuÃ©rdame','recordatorio','recuÃ©rdame que'], phrases:['recuÃ©rdame que llame al mÃ©dico maÃ±ana'], replies:[
    'No puedo ejecutar notificaciones persistentes fuera del navegador. Puedo darte instrucciones para crear un recordatorio en Google Calendar o una notificaciÃ³n local (Web Notifications + Service Worker) y un ejemplo de cÃ³digo.'
  ], priority:14 },

  /* --- Comida y recetas --- */
  { id:'tortilla_patatas', keywords:['tortilla de patatas','cÃ³mo se hace una tortilla de patatas','como se hace tortilla de patatas'], phrases:[], replies:[
    'Receta bÃ¡sica de tortilla de patatas:\n1) Pela y corta 4 patatas en rodajas finas, sofrÃ­e en aceite a fuego medio hasta tiernas.\n2) Bate 5 huevos, mezcla con las patatas escurridas y cebolla (opcional).\n3) Cuaja en sartÃ©n a fuego medio-bajo, da la vuelta y termina de cocinar.\nTiempo total: ~30â€“40 min.'
  ], priority:18 },

  { id:'pizza_calories', keywords:['calorÃ­as pizza','cuÃ¡ntas calorÃ­as tiene una pizza','calorias pizza'], phrases:[], replies:[
    'Depende del tamaÃ±o y ingredientes. Una porciÃ³n (1/8 de pizza mediana) puede tener entre 200â€“350 kcal. Una pizza entera varÃ­a entre 1,600â€“3,000 kcal segÃºn ingredientes.'
  ], priority:14 },

  { id:'rice_chicken_recipe', keywords:['cocinar con arroz y pollo','quÃ© cocinar con arroz y pollo'], phrases:[], replies:[
    'Una idea rÃ¡pida: arroz salteado con pollo: saltea trozos de pollo con ajo y verduras, aÃ±ade arroz cocido, salsa de soja y huevo revuelto. FÃ¡cil y rÃ¡pido.'
  ], priority:14 },

  { id:'boil_egg', keywords:['cuÃ¡nto tiempo hervir un huevo','tiempo hervir huevo','hervir huevo tiempo'], phrases:[], replies:[
    'Huevo pasado por agua: 4â€“6 min; huevo medio cocido: 7â€“9 min; huevo duro: 10â€“12 min (desde que el agua hierve). Ajusta por tamaÃ±o y altitud.'
  ], priority:14 },

  { id:'easy_vegetarian', keywords:['receta vegetariana fÃ¡cil','receta vegetariana'], phrases:[], replies:[
    'Recipe: Salteado de garbanzos y verduras: saltea cebolla, pimiento, aÃ±ade garbanzos cocidos, tomate, especias (comino/pimentÃ³n). Sirve con arroz o pan.'
  ], priority:14 },

  { id:'italian_food', keywords:['comida tÃ­pica italia','comida tÃ­pica de italia'], phrases:[], replies:[
    'Platos tÃ­picos: pasta (carbonara, bolognesa), pizza napolitana, risotto, lasaÃ±a y tiramisÃº como postre tradicional.'
  ], priority:14 },

  { id:'al_dente', keywords:['quÃ© significa al dente','al dente significado'], phrases:[], replies:[
    'â€œAl denteâ€ significa que la pasta estÃ¡ cocida pero conserva firmeza al morderla; no blanda. Se logra cocinando el tiempo indicado y probando un trozo.'
  ], priority:14 },

  { id:'homemade_bread', keywords:['hacer pan casero','cÃ³mo se hace pan casero'], phrases:[], replies:[
    'Receta bÃ¡sica: harina (500 g), agua tibia (300 ml), levadura (7 g seca), sal (10 g). Amasar, fermentar 1â€“2 h, dar forma, hornear 30â€“40 min a 220Â°C.'
  ], priority:14 },

  { id:'no_sugar_desserts', keywords:['postres sin azÃºcar','postres que no llevan azÃºcar'], phrases:[], replies:[
    'Ideas: yogur natural con fruta, mousse de aguacate y cacao endulzado con stevia/eritritol, compota de manzana sin azÃºcar aÃ±adida.'
  ], priority:12 },

  { id:'egg_protein', keywords:['proteÃ­nas huevo','cuÃ¡ntas proteÃ­nas tiene un huevo','proteÃ­nas huevo'], phrases:[], replies:[
    'Un huevo mediano tiene alrededor de 6â€“7 g de proteÃ­na (la clara contiene la mayor parte).'
  ], priority:14 },

  /* --- Viajes y lugares --- */
  { id:'cheap_travel', keywords:['viajar con poco dinero','dÃ³nde puedo viajar con poco dinero'], phrases:[], replies:[
    'Busca destinos con costo de vida bajo, vuelos con ofertas (low-cost), y viaja en temporada baja. Ejemplos: algunos paÃ­ses del sudeste asiÃ¡tico, Europa del Este o rutas locales en tu paÃ­s.'
  ], priority:12 },

  { id:'best_time_japan', keywords:['mejor Ã©poca japÃ³n','mejor Ã©poca para ir a japÃ³n'], phrases:[], replies:[
    'Primavera (marzo-mayo, temporada de sakura) y otoÃ±o (septiembre-noviembre) suelen ser las mejores Ã©pocas por clima y paisaje. Evita temporada de tifones (verano tardÃ­o).'
  ], priority:14 },

  { id:'paris_3days', keywords:['quÃ© ver en parÃ­s en tres dÃ­as','parÃ­s tres dÃ­as'], phrases:[], replies:[
    'DÃ­a 1: Torre Eiffel, Campos de Marte, paseo por Sena. DÃ­a 2: Louvre, Catedral de Notre-Dame, Barrio Latino. DÃ­a 3: Montmartre, SacrÃ©-CÅ“ur y compras en Le Marais.'
  ], priority:14 },

  { id:'flight_ny_cost', keywords:['vuelo nueva york cuanto cuesta','cuÃ¡nto cuesta un vuelo a nueva york'], phrases:[], replies:[
    'El precio varÃ­a segÃºn temporada y origen. Busca en comparadores (Skyscanner, Google Flights) para obtener precios actuales. Puedo dar un ejemplo de cÃ³mo consultar APIs si quieres.'
  ], priority:12 },

  { id:'us_visa', keywords:['necesito visado estados unidos','necesito visado para ir a estados unidos'], phrases:[], replies:[
    'Depende de tu nacionalidad. Muchos paÃ­ses usan el Programa de ExenciÃ³n de Visado (ESTA). Consulta la web oficial del gobierno de EE. UU. para requisitos exactos.'
  ], priority:16 },

  { id:'colosseum', keywords:['dÃ³nde estÃ¡ el coliseo','donde esta el coliseo romano'], phrases:[], replies:[
    'El Coliseo (Colosseo) estÃ¡ en Roma, Italia, en la zona del Foro Romano. Es uno de los principales monumentos turÃ­sticos de la ciudad.'
  ], priority:14 },

  { id:'canada_language', keywords:['idioma canadÃ¡','quÃ© idioma se habla en canadÃ¡'], phrases:[], replies:[
    'CanadÃ¡ tiene dos idiomas oficiales: inglÃ©s y francÃ©s (francÃ©s principalmente en la provincia de Quebec).'
  ], priority:14 },

  { id:'euro_countries', keywords:['paÃ­ses usan euros','quÃ© paÃ­ses usan euros'], phrases:[], replies:[
    'El euro es la moneda oficial de los paÃ­ses de la eurozona (ej. EspaÃ±a, Francia, Alemania, Italia, PaÃ­ses Bajos, etc.). Hay mÃ¡s de 19 paÃ­ses que usan el euro; consulta la lista actualizada en la UE.'
  ], priority:14 },

  { id:'madrid_barcelona_train', keywords:['tren madrid barcelona cuanto tarda','cuÃ¡nto tarda tren madrid barcelona'], phrases:[], replies:[
    'El AVE entre Madrid y Barcelona tarda aproximadamente 2h 30min a 3h, dependiendo del servicio. Consulta horarios de Renfe para tiempos exactos.'
  ], priority:14 },

  { id:'safe_travel_alone', keywords:['lugares seguros viajar solo','es seguro viajar solo'], phrases:[], replies:[
    'Viajar solo es posible y seguro si eliges destinos con buena infraestructura turÃ­stica y sigues precauciones: alojamiento con buenos reviews, evitar zonas aisladas de noche y llevar seguros de viaje.'
  ], priority:12 },

  /* --- Vida diaria y ayuda rÃ¡pida --- */
  { id:'wifi_not_work', keywords:['no funciona wifi','wifi no funciona','quÃ© hacer si no funciona el wifi'], phrases:[], replies:[
    'Prueba reiniciar el router, comprobar si otros dispositivos se conectan, olvidar y reconectar la red en el dispositivo, y probar con conexiÃ³n por cable (si es posible).'
  ], priority:16 },

  { id:'restart_phone', keywords:['reiniciar movil','reiniciar mi mÃ³vil','cÃ³mo reinicio mi mÃ³vil'], phrases:[], replies:[
    'Generalmente mantÃ©n pulsado el botÃ³n de encendido y selecciona "Reiniciar" o "Apagar". En algunos mÃ³viles hay combinaciones de botones (Power + Volumen). Dime modelo si necesitas pasos exactos.'
  ], priority:14 },

  { id:'clear_history', keywords:['borrar historial navegaciÃ³n','cÃ³mo borro historial','borrar historial'], phrases:[], replies:[
    'En la mayorÃ­a de navegadores: MenÃº â†’ Historial â†’ Borrar datos de navegaciÃ³n (selecciona tiempo y tipos: historial, cookies, cachÃ©).'
  ], priority:14 },

  { id:'forgot_password', keywords:['olvidÃ© mi contraseÃ±a','que hacer si olvidÃ© mi contraseÃ±a','olvidÃ© contraseÃ±a'], phrases:[], replies:[
    'Usa la opciÃ³n "OlvidÃ© mi contraseÃ±a" en el servicio; normalmente enviarÃ¡n un email para restablecer. Si no tienes acceso al email, contacta soporte del servicio.'
  ], priority:14 },

  { id:'airplane_mode', keywords:['quÃ© significa modo aviÃ³n','modo aviÃ³n que es'], phrases:[], replies:[
    'Modo aviÃ³n desactiva las comunicaciones inalÃ¡mbricas (celular, wifi y Bluetooth en algunos dispositivos), pensado para evitar interferencias en vuelos.'
  ], priority:14 },

  { id:'save_battery_android', keywords:['ahorrar baterÃ­a android','cÃ³mo ahorrar baterÃ­a en android'], phrases:[], replies:[
    'Consejos: reducir brillo, desactivar GPS/wifi cuando no se usa, cerrar apps en segundo plano, activar modo ahorro de baterÃ­a y revisar apps que consumen energÃ­a.'
  ], priority:14 },

  { id:'recover_photos', keywords:['recuperar fotos borradas','recuperar fotos'], phrases:[], replies:[
    'Si se borraron recientemente, revisa la papelera de la app (Google Photos, iOS). Para borrados mÃ¡s antiguos, puedes intentar software de recuperaciÃ³n o copias de seguridad.'
  ], priority:14 },

  { id:'mic_not_work', keywords:['no se escucha micrÃ³fono','micrÃ³fono no funciona','por quÃ© no se escucha el micrÃ³fono'], phrases:[], replies:[
    'Verifica permisos en el navegador/app, comprueba el dispositivo por defecto en configuraciÃ³n de sonido, prueba con otro micrÃ³fono o reinicia el equipo.'
  ], priority:14 },

  { id:'connect_controller', keywords:['conectar mando al pc','conectar mando pc'], phrases:[], replies:[
    'Conecta por USB o empareja por Bluetooth. Para mandos Xbox en Windows suele funcionar plug & play; para PS4/PS5 puede requerir software adicional o Steam Input.'
  ], priority:14 },

  { id:'which_android', keywords:['quÃ© versiÃ³n de android tengo','que version de android tengo'], phrases:[], replies:[
    'En Android: Ajustes â†’ Sistema â†’ Acerca del telÃ©fono â†’ InformaciÃ³n de software (o similar) para ver la versiÃ³n de Android.'
  ], priority:14 },

  /* --- EducaciÃ³n y aprendizaje --- */
  { id:'photosynthesis', keywords:['fotosÃ­ntesis','quÃ© es la fotosÃ­ntesis'], phrases:[], replies:[
    'La fotosÃ­ntesis es el proceso por el que las plantas (y algunas bacterias) convierten luz, COâ‚‚ y agua en glucosa y oxÃ­geno usando clorofila.'
  ], priority:16 },

  { id:'mass_vs_weight', keywords:['masa y peso diferencia','masa vs peso'], phrases:[], replies:[
    'Masa es la cantidad de materia (kg); peso es la fuerza gravitatoria sobre esa masa (N). En la Tierra usamos kg para masa y N (o kgf) para peso; varÃ­a con la gravedad.'
  ], priority:16 },

  { id:'quadratic_equation', keywords:['ecuaciÃ³n cuadrÃ¡tica','cÃ³mo resolver ecuaciÃ³n cuadrÃ¡tica','resolver ecuaciÃ³n cuadrÃ¡tica'], phrases:[], replies:[
    'Para axÂ²+bx+c=0 usa la fÃ³rmula: x = (-b Â± âˆš(bÂ²-4ac)) / (2a). Si discriminante es negativo no hay soluciones reales.'
  ], priority:16 },

  { id:'quijote_summary', keywords:['resumen el quijote','resumen de el quijote'], phrases:[], replies:[
    'El Quijote (Miguel de Cervantes) narra las aventuras de Alonso Quijano, quien, tras leer novelas de caballerÃ­a, se convierte en Don Quijote y sale a reparar injusticias junto a Sancho Panza. Es una sÃ¡tira de los libros de caballerÃ­a y una reflexiÃ³n sobre la realidad y la ficciÃ³n.'
  ], priority:14 },

  { id:'french_revolution', keywords:['revoluciÃ³n francesa','quÃ© fue la revoluciÃ³n francesa'], phrases:[], replies:[
    'La RevoluciÃ³n Francesa (1789) fue un periodo de cambio polÃ­tico y social en Francia que derrocÃ³ la monarquÃ­a absoluta, introdujo principios de igualdad y ciudadanÃ­a, y llevÃ³ a profundas transformaciones europeas.'
  ], priority:14 },

  { id:'irregular_verb', keywords:['verbo irregular','quÃ© es un verbo irregular'], phrases:[], replies:[
    'Un verbo irregular no sigue la conjugaciÃ³n regular en pasado o participio (por ejemplo, "go" â†’ "went", "gone").'
  ], priority:14 },

  { id:'types_of_energy', keywords:['tipos de energÃ­a','cuÃ¡les son los tipos de energÃ­a'], phrases:[], replies:[
    'Ejemplos: energÃ­a cinÃ©tica, potencial, tÃ©rmica, quÃ­mica, elÃ©ctrica, nuclear, renovable (solar, eÃ³lica, hidrÃ¡ulica).'
  ], priority:14 },

  { id:'mitosis', keywords:['mitosis','quÃ© es la mitosis'], phrases:[], replies:[
    'La mitosis es el proceso de divisiÃ³n celular que produce dos cÃ©lulas hijas genÃ©ticamente idÃ©nticas a la cÃ©lula madre; tiene fases: profase, metafase, anafase y telofase.'
  ], priority:14 },

  { id:'plural_english', keywords:['plural en inglÃ©s','cÃ³mo se forma el plural en inglÃ©s'], phrases:[], replies:[
    'Regla general: aÃ±ade -s (cat â†’ cats). Si termina en s, x, ch, sh o o aÃ±ade -es. Hay plurales irregulares (mouse â†’ mice, child â†’ children).'
  ], priority:14 },

  { id:'spain_flag', keywords:['significado bandera de espaÃ±a','quÃ© significa la bandera de espaÃ±a'], phrases:[], replies:[
    'La bandera de EspaÃ±a tiene franjas rojas y amarilla; el escudo incluye los reinos histÃ³ricos (Castilla, LeÃ³n, AragÃ³n, Navarra, Granada) y las columnas de HÃ©rcules con el lema "Plus Ultra".'
  ], priority:12 },

  /* --- Conversaciones y curiosidad (chistes, historia, juegos) --- */
  { id:'joke', keywords:['chiste','cuÃ©ntame un chiste','dime un chiste'], phrases:[], replies:[
    'â€” Â¿Por quÃ© los programadores confunden Halloween y Navidad? Porque OCT 31 == DEC 25.',
    'â€” Â¿QuÃ© le dijo un bit al otro? Nos vemos en el bus.'
  ], priority:16 },

  { id:'science_fact', keywords:['curiosidad cientÃ­fica','dime una curiosidad cientÃ­fica'], phrases:[], replies:[
    'Curiosidad: el agua existen en tres estados (sÃ³lido, lÃ­quido, gas) y la densidad del agua es mÃ¡xima a 4Â°C. Otra: las abejas pueden reconocer rostros.'
  ], priority:12 },

  { id:'fav_color', keywords:['color favorito','cual es tu color favorito'], phrases:[], replies:[
    'No tengo gustos personales reales, pero si quieres puedo elegir uno por estilo: me gustan los tonos turquesa (#57e4b8).'
  ], priority:8 },

  { id:'sing_song', keywords:['puedes cantar una canciÃ³n','canta una canciÃ³n'], phrases:[], replies:[
    'No puedo cantar con voz real (a menos que actives TTS). Puedo escribir la letra o entonar un pÃ¡rrafo con TTS si lo deseas.'
  ], priority:8 },

  { id:'short_story', keywords:['inventa una historia corta','inventa historia'], phrases:[], replies:[
    () => `Ã‰rase una vez un pequeÃ±o robot llamado Aden que enseÃ±aba a la gente a programar... (puedo extender la historia si quieres).`
  ], priority:12 },

  { id:'motivational', keywords:['frase motivadora','dame una frase motivadora'], phrases:[], replies:[
    'â€œNo es la carga lo que te rompe, sino la manera en que la llevas.â€ â€” MantÃ©n pequeÃ±os pasos consistentes cada dÃ­a.',
    'â€œHaz hoy lo que otros no quieren, y vivirÃ¡s maÃ±ana como otros no pueden.â€'
  ], priority:12 },

  { id:'meaning_of_life', keywords:['sentido de la vida','cuÃ¡l es el sentido de la vida'], phrases:[], replies:[
    'Muchas respuestas existen: para algunos es buscar felicidad y conexiÃ³n, para otros contribuir o aprender. FilosÃ³ficamente es una pregunta abierta: Â¿quÃ© te gustarÃ­a que fuera?'
  ], priority:8 },

  { id:'yoda', keywords:['imitar a yoda','puedes imitar a yoda'], phrases:[], replies:[
    'Hablar como Yoda: "Hacerlo debes, si Ã©xito buscas." (puedo transformar frases al estilo Yoda si quieres).'
  ], priority:8 },

  { id:'opinion_future', keywords:['futuro de la humanidad','quÃ© opinas del futuro de la humanidad'], phrases:[], replies:[
    'El futuro depende de decisiones sobre tecnologÃ­a, clima y cooperaciÃ³n global. Hay desafÃ­os y oportunidades; el progreso responsable es crÃ­tico.'
  ], priority:10 },

  { id:'quiz_game', keywords:['juguemos','juego preguntas y respuestas','juguemos a un juego'], phrases:[], replies:[
    'Perfecto â€” puedo iniciar un juego de preguntas: te pregunto 5 preguntas de cultura general y contabilizo tu puntuaciÃ³n. Â¿Quieres empezar?'
  ], priority:10 },

  /* Fallback */
  { id:'default', keywords:[], phrases:[], replies:[
    'Lo siento, no he entendido del todo. Â¿Puedes reformular? Prueba con palabras clave: "hora", "quiÃ©n fue", "receta", "guardar", "trucos PC", etc.',
    'Si la pregunta requiere datos en tiempo real (precios, estrenos, ofertas), puedo mostrarte cÃ³mo consultarlos mediante fetch/APIs.'
  ], priority:1 }
];

/* ---------- Utilidades y matching flexible ---------- */
function uid(prefix='id'){ return `${prefix}_${Math.random().toString(36).slice(2,9)}`; }
function now(){ return new Date().toISOString(); }
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify({chats,assistantLimit,ttsEnabled})); }
function load(){ const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return; try{ const obj=JSON.parse(raw); chats = obj.chats||[]; assistantLimit = obj.assistantLimit||DEFAULT_LIMIT; ttsEnabled = !!obj.ttsEnabled; } catch(e){console.warn(e);} }
function normalize(s=''){ return String(s).toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^\w\s]/g,' ').trim(); }
function tokens(s=''){ return new Set(normalize(s).split(/\s+/).filter(Boolean)); }

// detect best responder by scoring keywords and phrases
function detectResponder(text){
  if(!text) return RESPONDERS.find(r=>r.id==='default');
  const norm = normalize(text);
  const tset = tokens(text);
  let best=null, bestScore=-Infinity;
  for(const r of RESPONDERS){
    let score = 0;
    for(const k of (r.keywords||[])){
      if(tset.has(normalize(k))) score += 4;
      else if(norm.includes(normalize(k))) score += 2;
    }
    for(const p of (r.phrases||[])){
      if(norm.includes(normalize(p))) score += 3;
    }
    score += (r.priority || 0);
    if(score > bestScore){ bestScore = score; best = r; }
  }
  if(!best || bestScore <= 5) return RESPONDERS.find(r=>r.category==='fallback') || RESPONDERS.find(r=>r.id==='default') || RESPONDERS[RESPONDERS.length-1];
  return best;
}

function chooseReply(responder, userText=''){
  if(!responder) responder = RESPONDERS.find(r=>r.id==='default');
  const opts = responder.replies || [];
  const pick = opts[Math.floor(Math.random()*opts.length)];
  if(typeof pick === 'function') return pick(userText);
  return pick;
}

/* ---------- Chat logic (mensajes, render, typing simulation) ---------- */
function createChat(name){ const c={id:uid('chat'),name:name||('Chat '+(chats.length+1)),messages:[],assistantCount:0,created:now()}; chats.unshift(c); activeChatId=c.id; pushUndo({type:'createChat',chat:c}); save(); renderChats(); renderActiveChat(); return c; }
function deleteChat(id){ const idx=chats.findIndex(x=>x.id===id); if(idx===-1) return; const removed=chats.splice(idx,1)[0]; pushUndo({type:'deleteChat',chat:removed,idx}); if(activeChatId===id) activeChatId=chats.length?chats[0].id:null; save(); renderChats(); renderActiveChat(); }
function renameChat(id,newName){ const c=chats.find(x=>x.id===id); if(!c) return; const old=c.name; c.name=newName; pushUndo({type:'renameChat',chatId:id,oldName:old,newName}); save(); renderChats(); renderActiveChat(); }
function clearChat(id){ const c=chats.find(x=>x.id===id); if(!c) return; const snapshot=JSON.parse(JSON.stringify(c.messages)); c.messages=[]; c.assistantCount=0; pushUndo({type:'clearChat',chatId:id,snapshot}); save(); renderActiveChat(); }

function addUserMessage(chatId,text){ const c=chats.find(x=>x.id===chatId); if(!c) return; const m={id:uid('m'),role:'user',text,ts:now()}; c.messages.push(m); pushUndo({type:'addMessage',chatId,msg:m}); save(); renderActiveChat(); }
function addAssistantMessage(chatId,text){ const c=chats.find(x=>x.id===chatId); if(!c) return; const m={id:uid('m'),role:'assistant',text,ts:now()}; c.messages.push(m); c.assistantCount=(c.assistantCount||0)+1; pushUndo({type:'addMessage',chatId,msg:m}); save(); renderActiveChat(); }
function deleteMessage(chatId,msgId){ const c=chats.find(x=>x.id===chatId); if(!c) return; const idx=c.messages.findIndex(m=>m.id===msgId); if(idx===-1) return; const removed=c.messages.splice(idx,1)[0]; if(removed.role==='assistant') c.assistantCount=Math.max(0,(c.assistantCount||0)-1); pushUndo({type:'deleteMessage',chatId,msg:removed,idx}); save(); renderActiveChat(); }

/* Typing simulation for UX */
async function simulateTyping(chatId,finalText){
  const messagesArea = document.getElementById('messagesArea');
  const bubble = document.createElement('div'); bubble.className='bubble assistant'; bubble.innerHTML = '<div class="muted">Aden estÃ¡ escribiendo</div><div style="height:14px"></div>'; messagesArea.appendChild(bubble); messagesArea.scrollTop = messagesArea.scrollHeight;
  await sleep(400 + Math.random()*700);
  bubble.innerHTML = '';
  const textEl = document.createElement('div'); bubble.appendChild(textEl);
  const chars = finalText.split('');
  const base = Math.max(3, Math.min(18, 12 - Math.floor(chars.length/80)));
  for(let i=0;i<chars.length;i++){
    textEl.textContent += chars[i];
    messagesArea.scrollTop = messagesArea.scrollHeight;
    await sleep(base + Math.random()*10);
  }
  const meta = document.createElement('div'); meta.className='muted'; meta.style.fontSize='12px'; meta.style.marginTop='8px'; meta.textContent = new Date().toLocaleTimeString();
  bubble.appendChild(meta);
  // commit
  const c = chats.find(x=>x.id===chatId); if(c){ c.messages.push({id:uid('m'),role:'assistant',text:finalText,ts:now()}); c.assistantCount=(c.assistantCount||0)+1; pushUndo({type:'addMessage',chatId,msg:c.messages[c.messages.length-1]}); save(); }
  if(ttsEnabled && 'speechSynthesis' in window){ try{ const u = new SpeechSynthesisUtterance(finalText); u.lang='es-ES'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){console.warn(e);} }
}

/* ---------- Helpers ---------- */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function escapeHtml(s=''){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* ---------- Render UI ---------- */
function renderChats(filter=''){
  const el = document.getElementById('chatsList'); el.innerHTML=''; const f = normalize(filter);
  for(const c of chats){
    if(f && !normalize(c.name).includes(f) && !(c.messages||[]).some(m=>normalize(m.text).includes(f))) continue;
    const item = document.createElement('div'); item.className='chat-item'; if(c.id===activeChatId) item.style.outline='2px solid rgba(87,228,184,0.08)';
    item.addEventListener('click',()=>{ activeChatId=c.id; renderChats(); renderActiveChat(); });
    const thumb = document.createElement('div'); thumb.style.width='42px'; thumb.style.height='42px'; thumb.style.borderRadius='8px'; thumb.style.background='linear-gradient(135deg,#c7f9e8,#9fd1ff)'; thumb.style.display='flex'; thumb.style.alignItems='center'; thumb.style.justifyContent='center'; thumb.style.fontWeight='700'; thumb.style.color='#022';
    thumb.textContent = c.name.split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
    const meta = document.createElement('div');
    meta.innerHTML = `<div style="font-size:13px">${escapeHtml(c.name)}</div><div class="muted" style="font-size:12px">${c.messages.length} mensajes Â· ${c.assistantCount||0} respuestas</div>`;
    const actions = document.createElement('div'); actions.style.marginLeft='auto';
    const btnR = document.createElement('button'); btnR.className='btn'; btnR.textContent='âœŽ'; btnR.onclick = (ev)=>{ ev.stopPropagation(); const n=prompt('Nuevo nombre', c.name); if(n) renameChat(c.id,n.trim()); };
    const btnD = document.createElement('button'); btnD.className='btn'; btnD.textContent='ðŸ—‘'; btnD.onclick = (ev)=>{ ev.stopPropagation(); if(confirm('Eliminar chat "'+c.name+'"?')) deleteChat(c.id); };
    actions.appendChild(btnR); actions.appendChild(btnD);
    item.appendChild(thumb); item.appendChild(meta); item.appendChild(actions);
    el.appendChild(item);
  }
  document.getElementById('limitDisplay').textContent = assistantLimit;
}

function renderActiveChat(){
  const area = document.getElementById('messagesArea'); area.innerHTML='';
  const c = chats.find(x=>x.id===activeChatId);
  const title = document.getElementById('panelTitle');
  if(!c){ title.textContent='Selecciona o crea un chat'; document.getElementById('responsesLeft').textContent=''; document.getElementById('deleteChatBtn').disabled=true; return; }
  title.textContent = c.name;
  document.getElementById('deleteChatBtn').disabled=false;
  const left = Math.max(0, assistantLimit - (c.assistantCount||0));
  document.getElementById('responsesLeft').textContent = `${left} respuestas restantes (lÃ­mite ${assistantLimit})`;
  if(c.messages.length===0) area.innerHTML = '<div class="muted">Chat vacÃ­o. Escribe una pregunta para empezar â€” por ejemplo: "Â¿QuÃ© hora es?"</div>';
  for(const m of c.messages){
    const b = document.createElement('div'); b.className='bubble '+(m.role==='user'?'user':'assistant'); b.setAttribute('data-id',m.id);
    b.innerHTML = `<div>${escapeHtml(m.text).replace(/\n/g,'<br/>')}</div><div class="muted" style="margin-top:8px;font-size:12px">${new Date(m.ts).toLocaleString()} <button class="btn" data-del="${m.id}" style="margin-left:8px">ðŸ—‘</button></div>`;
    area.appendChild(b);
  }
  // attach delete handlers
  area.querySelectorAll('button[data-del]').forEach(btn=> btn.addEventListener('click', (ev)=>{ const id=btn.getAttribute('data-del'); if(confirm('Borrar mensaje?')) deleteMessage(activeChatId,id); }));
  area.scrollTop = area.scrollHeight;
  renderSuggestions();
}

const SUGS = ['Â¿QuÃ© hora es?','Â¿QuÃ© dÃ­a es hoy?','EscrÃ­beme un correo formal','CÃ³mo liberar espacio en mi PC','Receta tortilla de patatas','CuÃ©ntame un chiste'];
function renderSuggestions(){
  const s = document.getElementById('suggestions'); s.innerHTML=''; for(const t of SUGS){ const chip=document.createElement('div'); chip.className='chip'; chip.textContent=t; chip.onclick=()=>{ document.getElementById('inputTxt').value=t; updateChar(); document.getElementById('inputTxt').focus(); }; s.appendChild(chip); }
}

/* ---------- Send flow: detectar intenciÃ³n y responder ---------- */
async function handleSend(){
  const input = document.getElementById('inputTxt'); const text = input.value.trim();
  if(!text) return;
  if(!activeChatId){ const c = createChat('Chat rÃ¡pido'); activeChatId = c.id; }
  addUserMessage(activeChatId, text);
  input.value=''; updateChar();
  const c = chats.find(x=>x.id===activeChatId);
  if((c.assistantCount||0) >= assistantLimit){ await simulateTyping(activeChatId, 'He alcanzado el lÃ­mite de respuestas en este chat. Crea uno nuevo o aumenta el lÃ­mite.'); return; }
  const responder = detectResponder(text);
  const reply = chooseReply(responder, text);
  // Typing simulation + commit
  await simulateTyping(activeChatId, reply);
}

/* ---------- Undo / Redo (simple pero funcional) ---------- */
function pushUndo(action){ undoStack.push(action); if(undoStack.length>200) undoStack.shift(); redoStack=[]; }
function undo(){ const a=undoStack.pop(); if(!a) return alert('Nada que deshacer'); switch(a.type){ case 'addMessage': { const c=chats.find(x=>x.id===a.chatId); if(c){ const idx=c.messages.findIndex(m=>m.id===a.msg.id); if(idx!==-1) c.messages.splice(idx,1); if(a.msg.role==='assistant') c.assistantCount=Math.max(0,(c.assistantCount||0)-1); redoStack.push(a); save(); renderActiveChat(); } break;} case 'deleteMessage': { const c=chats.find(x=>x.id===a.chatId); if(c){ c.messages.splice(a.idx,0,a.msg); if(a.msg.role==='assistant') c.assistantCount=(c.assistantCount||0)+1; redoStack.push(a); save(); renderActiveChat(); } break;} case 'createChat': { const idx=chats.findIndex(x=>x.id===a.chat.id); if(idx!==-1){ chats.splice(idx,1); redoStack.push(a); save(); renderChats(); renderActiveChat(); } break;} case 'deleteChat': { chats.splice(a.idx,0,a.chat); redoStack.push(a); save(); renderChats(); renderActiveChat(); break;} case 'renameChat': { const c=chats.find(x=>x.id===a.chatId); if(c){ c.name=a.oldName; redoStack.push(a); save(); renderChats(); renderActiveChat(); } break;} case 'clearChat': { const c=chats.find(x=>x.id===a.chatId); if(c){ c.messages=a.snapshot; c.assistantCount=c.messages.filter(m=>m.role==='assistant').length; redoStack.push(a); save(); renderActiveChat(); } break;} default: alert('Deshacer no soportado: '+a.type); } }
function redo(){ const a=redoStack.pop(); if(!a) return alert('Nada que rehacer'); switch(a.type){ case 'addMessage': { const c=chats.find(x=>x.id===a.chatId); if(c){ c.messages.push(a.msg); if(a.msg.role==='assistant') c.assistantCount=(c.assistantCount||0)+1; undoStack.push(a); save(); renderActiveChat(); } break;} case 'deleteMessage': { const c=chats.find(x=>x.id===a.chatId); if(c){ const idx=c.messages.findIndex(m=>m.id===a.msg.id); if(idx!==-1){ c.messages.splice(idx,1); if(a.msg.role==='assistant') c.assistantCount=Math.max(0,(c.assistantCount||0)-1); undoStack.push(a); save(); renderActiveChat(); } } break;} case 'createChat': { chats.unshift(a.chat); undoStack.push(a); save(); renderChats(); renderActiveChat(); break;} case 'deleteChat': { const idx=chats.findIndex(x=>x.id===a.chat.id); if(idx!==-1){ chats.splice(idx,1); undoStack.push(a); save(); renderChats(); renderActiveChat(); } break;} case 'renameChat': { const c=chats.find(x=>x.id===a.chatId); if(c){ c.name=a.newName; undoStack.push(a); save(); renderChats(); renderActiveChat(); } break;} case 'clearChat': { const c=chats.find(x=>x.id===a.chatId); if(c){ c.messages=[]; c.assistantCount=0; undoStack.push(a); save(); renderActiveChat(); } break;} default: alert('Rehacer no soportado: '+a.type); } }

/* ---------- Eventos UI ---------- */
document.getElementById('newChatBtn').addEventListener('click', ()=> { const n=prompt('Nombre del nuevo chat','ConversaciÃ³n '+(chats.length+1)); createChat(n? n.trim() : undefined); });
document.getElementById('exportAllBtn').addEventListener('click', ()=> { const blob=new Blob([JSON.stringify({chats,assistantLimit},null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='aden_chats.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); });
document.getElementById('resetLocal').addEventListener('click', ()=> { if(confirm('Borrar todos los datos locales?')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } });
document.getElementById('searchChats').addEventListener('input', (e)=> renderChats(e.target.value));
document.getElementById('sendBtn').addEventListener('click', handleSend);
document.getElementById('inputTxt').addEventListener('keydown', (ev)=> { if(ev.key==='Enter' && !ev.shiftKey){ ev.preventDefault(); handleSend(); } });
document.getElementById('inputTxt').addEventListener('input', updateChar);
document.getElementById('decLimit').addEventListener('click', ()=> { assistantLimit=Math.max(1,assistantLimit-1); document.getElementById('limitDisplay').textContent = assistantLimit; save(); renderActiveChat(); });
document.getElementById('incLimit').addEventListener('click', ()=> { assistantLimit=Math.min(200,assistantLimit+1); document.getElementById('limitDisplay').textContent = assistantLimit; save(); renderActiveChat(); });
document.getElementById('clearChatBtn').addEventListener('click', ()=> { if(!activeChatId) return alert('Selecciona un chat'); if(confirm('Vaciar historial?')) clearChat(activeChatId); });
document.getElementById('renameChatBtn').addEventListener('click', ()=> { if(!activeChatId) return alert('Selecciona un chat'); const c=chats.find(x=>x.id===activeChatId); const nn=prompt('Nuevo nombre', c.name); if(nn) renameChat(c.id, nn.trim()); });
document.getElementById('deleteChatBtn').addEventListener('click', ()=> { if(!activeChatId) return alert('Selecciona un chat'); const c=chats.find(x=>x.id===activeChatId); if(confirm('Eliminar chat "'+c.name+'"?')) deleteChat(c.id); });
document.getElementById('undoBtn').addEventListener('click', ()=> undo());
document.getElementById('redoBtn').addEventListener('click', ()=> redo());
document.getElementById('ttsToggle').addEventListener('click', ()=> { ttsEnabled = !ttsEnabled; document.getElementById('ttsToggle').classList.toggle('primary', ttsEnabled); document.getElementById('ttsToggle').textContent = ttsEnabled ? 'ðŸ”Š ON' : 'ðŸ”Š'; save(); });

/* ---------- UI helpers ---------- */
function updateChar(){ document.getElementById('charCount').textContent = document.getElementById('inputTxt').value.length + ' caracteres'; }

/* ---------- Init ---------- */
(function init(){ load(); if(chats.length===0){ const c=createChat('Bienvenida'); c.messages.push({id:uid('m'),role:'assistant',text:'Â¡Hola! Soy Aden â€” tu asistente local. PregÃºntame lo que quieras (ej.: "Â¿QuÃ© hora es?", "EscrÃ­beme un correo formal").',ts:now()}); c.assistantCount=1; save(); } if(!activeChatId && chats[0]) activeChatId=chats[0].id; renderChats(); renderActiveChat(); renderSuggestions(); document.getElementById('limitDisplay').textContent = assistantLimit; document.getElementById('ttsToggle').textContent = ttsEnabled ? 'ðŸ”Š ON' : 'ðŸ”Š'; })();

/* ---------- Exponer herramientas en consola (debug) ---------- */
window.ADEN = { chats, createChat, deleteChat, renameChat, detectResponder, RESPONDERS };

</script>
</body>
</html>

